apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-red
  namespace: banking
  labels:
    grafana_dashboard: "1"
data:
  transaction-red.json: |
    {
      "title": "Transaction Service - Full Metrics",
      "description": "Comprehensive dashboard for Transaction Service RED + Business metrics",
      "schemaVersion": 36,
      "refresh": "10s",
      "panels": [
        {
          "type": "stat",
          "title": "Total Transactions",
          "gridPos": { "x": 0, "y": 0, "w": 6, "h": 4 },
          "targets": [
            {
              "expr": "sum(transactions_total)",
              "legendFormat": "Total Transactions"
            }
          ]
        },
        {
          "type": "stat",
          "title": "Failed Transfers",
          "gridPos": { "x": 6, "y": 0, "w": 6, "h": 4 },
          "targets": [
            {
              "expr": "sum(failed_transfers_total)",
              "legendFormat": "Failed Transfers"
            }
          ]
        },
        {
          "type": "graph",
          "title": "Request Rate (RPS)",
          "gridPos": { "x": 0, "y": 4, "w": 12, "h": 8 },
          "targets": [
            {
              "expr": "sum(rate(http_requests_total[1m])) by (method, route)",
              "legendFormat": "{{method}} {{route}}"
            }
          ]
        },
        {
          "type": "graph",
          "title": "Error Rate (per second)",
          "gridPos": { "x": 0, "y": 12, "w": 12, "h": 8 },
          "targets": [
            {
              "expr": "sum(rate(http_request_errors_total[1m])) by (method, route)",
              "legendFormat": "{{method}} {{route}}"
            }
          ]
        },
        {
          "type": "graph",
          "title": "Request Duration (p50, p90, p99)",
          "gridPos": { "x": 0, "y": 20, "w": 12, "h": 8 },
          "targets": [
            {
              "expr": "histogram_quantile(0.5, sum(rate(http_request_duration_seconds_bucket[1m])) by (le))",
              "legendFormat": "p50"
            },
            {
              "expr": "histogram_quantile(0.9, sum(rate(http_request_duration_seconds_bucket[1m])) by (le))",
              "legendFormat": "p90"
            },
            {
              "expr": "histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket[1m])) by (le))",
              "legendFormat": "p99"
            }
          ]
        },
        {
          "type": "graph",
          "title": "Balance Check Latency (ms)",
          "gridPos": { "x": 0, "y": 28, "w": 12, "h": 8 },
          "targets": [
            {
              "expr": "histogram_quantile(0.5, sum(rate(balance_check_latency_ms_bucket[1m])) by (le))",
              "legendFormat": "p50"
            },
            {
              "expr": "histogram_quantile(0.9, sum(rate(balance_check_latency_ms_bucket[1m])) by (le))",
              "legendFormat": "p90"
            },
            {
              "expr": "histogram_quantile(0.99, sum(rate(balance_check_latency_ms_bucket[1m])) by (le))",
              "legendFormat": "p99"
            }
          ]
        },
        {
          "type": "table",
          "title": "Request Summary by Route",
          "gridPos": { "x": 0, "y": 36, "w": 12, "h": 8 },
          "targets": [
            {
              "expr": "sum(rate(http_requests_total[1m])) by (method, route)",
              "legendFormat": "{{method}} {{route}}"
            }
          ],
          "columns": [],
          "transformations": []
        }
      ],
      "templating": {
        "list": []
      },
      "time": {
        "from": "now-15m",
        "to": "now"
      },
      "timepicker": {
        "refresh_intervals": ["5s", "10s", "30s", "1m", "5m"]
      }
    }
